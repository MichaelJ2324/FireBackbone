!function(t){var e="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global;if("function"==typeof define&&define.amd)define(["underscore","backbone","exports"],function(i,s,n){e.FirebaseDBackbone=t(e,n,i,s)});else if("undefined"!=typeof exports){var i=require("underscore"),s=require("backbone");t(e,exports,i,s)}else e.FirebaseDBackbone=t(e,{},e._,e.Backbone)}(function(t,e,i,s){var n=t.FirebaseDBackbone;e.VERSION="0.1",e.noConflict=function(){return t.FirebaseDBackbone=n,this},e.firebaseApp=function(t){if(i.isUndefined(t)){if(i.isUndefined(firebase))throw new Error("No Firebase Application present");this._firebase=firebase.app()}else this._firebase=t;return this._firebase};var r=function(t){return t.key},o=function(t,e){var s=Object.getPrototypeOf(t);return i.extend({autoSync:!s.hasOwnProperty("_autoSync")||s._autoSync},this,e)._autoSync},c=function(t,s){var n=Object.getPrototypeOf(t),r=null;return!i.isUndefined(e._firebase)&&i.isFunction(e._firebase.database())&&(r=e.firebaseApp().database()),i.extend({database:n.hasOwnProperty("database")?n.database:r},this,s).database},a=function(t,e,i){i&&(t&&i.error?i.error(e,t,i):i.success&&i.success(e,null,i))};e.sync=function(t,e,i){var s=e.toJSON();return"read"===t?e.ref(!0).once("value",function(t){var e=t.val();i.success&&i.success(e)},function(t){i.error&&i.error(t)},e):"create"===t?e.ref(!0).set(s,function(t){a(t,s,i)}):"update"===t?e.ref(!0).update(s,function(t){a(t,s,i)}):"delete"===t?e.ref(!0).set(null,function(t){a(t,s,i)}):void 0};var u=function(t){throw new Error(t)},h=function(t,e){var i=t.val();return f(i)&&u("InvalidIdException: Models must have an Id. Note: You may be trying to sync a primitive value (int, string, bool)."),null===i&&(i={}),i[e]=r(t),i},f=function(t){return!i.isObject(t)&&null!==t},l=e.Model=s.Model.extend({initialize:function(t,e){this.autoSync(o(this,e)),this.database=c(this,e);var s=i.result(this,"defaults");this.once("sync",function(){this.set(i.defaults(this.toJSON(),s))})},autoSync:function(t){return i.isUndefined(t)||(t!==this._autoSync&&(!1===t?(this._closeRef(),this.off("change",this._autoSyncListeners.change),this.off("destroy",this._autoSyncListeners.destroy)):this._listenLocalChanges()),this._autoSync=t),this._autoSync},ref:function(t){return t=t||!1,(i.isUndefined(this._ref)||!0===t)&&(this._closeRef(),this._setRef(this.url()),this._configureRef()),this._ref},_setRef:function(t){switch(typeof t){case"object":this._ref=t;break;case"string":this._ref=this._buildRef(t);break;default:u("Invalid type returned from url method")}return this._ref},_buildRef:function(t){var e=/https:\/\/.*\.firebaseio\.com/i;return t.match(e)?this.database.refFromURL(t):this.database.ref(t)},_configureRef:function(){this.autoSync()&&this._ref.on("value",this._setLocal,function(t){this.trigger("FirebaseDBackbone:error",this,t,"value")},this)},_closeRef:function(){i.isUndefined(this._ref)||this._ref.off("value",this._setLocal,this)},_autoSyncListeners:{change:i.bind(function(t,e){t.autoSync()&&(t.hasChanged(t.idAttribute)&&t.ref(!0),t.save())},this),destroy:i.bind(function(t,e){t.autoSync()&&t.ref(!0)},this)},_listenLocalChanges:function(){this.on("change",this._autoSyncListeners.change),this.on("destroy",this._autoSyncListeners.destroy)},sync:function(t,i,s){e.sync(t,i,s)},_setLocal:function(t){var e=this._unsetAttributes(t),i={silent:!0};this.set(e,i)},_unsetAttributes:function(t){var e=h(t,this.idAttribute);if("object"==typeof e&&null!==e){var s=i.difference(i.keys(this.attributes),i.keys(e));i.each(s,function(t){this.unset(t)},this)}return this._setId(t),e},_setId:function(t){this.isNew()&&this.set(this.idAttribute,r(t),{silent:!0})},_updateModel:function(t){var e=t.changedAttributes();return i.each(t.changed,function(i,s){s==t.idAttribute&&delete e[s],void 0!==i&&null!==i||(e[s]=null)}),e}}),d=function(){function t(){}return t.protoype={create:function(t,e){var n=this.idAttribute();return t[n]=t[n]||r(this.ref().push()),e=i.extend({_autoSync:!1},e),s.Collection.prototype.create.call(this,t,e)},add:function(t,e){var n=this.idAttribute();return t[n]=t[n]||r(this.ref().push()),e=i.extend({_autoSync:!1},e),s.Collection.prototype.add.call(this,t,e)},sync:function(t,i,s){e.sync(t,i,s)},fetch:function(t){void 0===(t=t?i.clone(t):{}).parse&&(t.parse=!0);var e=t.success,s=this;return t.success=function(n){var r=[],o=i.keys(n);i.each(o,function(t){r.push(n[t])});var c=t.reset?"reset":"set";s[c](r,t),e&&e(s,r,t),t.autoSync=!1,t.url=this.url,s.trigger("sync",s,r,t)},this.sync("read",this,t)}},t}(),_=function(){function t(){this.listenTo(this,"change",this._updateModel,this),this.listenTo(this,"destroy",this._removeModel,this)}return t.protoype={add:function(t,e){var s=this._parseModels(t);(e=e?i.clone(e):{}).success=i.isFunction(e.success)?e.success:function(){};for(var n=0;n<s.length;n++){var r=s[n];!0===e.silent&&(this._suppressEvent=!0),this.ref().child(r[this.idAttribute]).set(r,i.bind(e.success,r))}return s},create:function(t,e){return(e=e?i.clone(e):{}).wait&&this._log("Wait option provided to create, ignoring."),!!t&&this.add([t],e)[0]},remove:function(t,e){var s=this._parseModels(t);(e=e?i.clone(e):{}).success=i.isFunction(e.success)?e.success:function(){};for(var n=0;n<s.length;n++){var r=s[n],o=this.ref().child(r[this.idAttribute()]);!0===e.silent&&(this._suppressEvent=!0),_setWithCheck(o,null,e)}return s},reset:function(t,e){e=e?i.clone(e):{},this.remove(this.models,{silent:!0});var s=this.add(t,{silent:!0});return e.silent||this.trigger("reset",this,e),s},fetch:function(t){var e=(t=i.extend({parse:!0},t)).success;this.autoSync()&&(t.reset||i.isNull(this._ref))&&(this.ref(!0),this._ref.on("child_added",this._childAdded,function(t){this.trigger("FirebaseDBackbone:error",this,t,"child_added")},this),this._ref.on("child_moved",this._childMoved,function(t){this.trigger("FirebaseDBackbone:error",this,t,"child_moved")},this),this._ref.on("child_changed",this._childChanged,function(t){this.trigger("FirebaseDBackbone:error",this,t,"child_changed")},this),this._ref.on("child_removed",this._childRemoved,function(t){this.trigger("FirebaseDBackbone:error",this,t,"child_removed")},this)),this.ref().once("value",function(){e&&e.call(t.context,this,t),this.trigger("sync",this,null,null)},function(t){this.trigger("FirebaseDBackbone:error",this,t,"value")},this)},_log:function(t){console&&console.log&&console.log(t)},_parseModels:function(t,e){var n=[];t=!i.isArray(t)?t?[t]:[]:t.slice();for(var o=this.idAttribute(),c=0;c<t.length;c++){var a=t[c];a[o]=a[o]||r(this.ref().push()),(a=s.Collection.prototype._prepareModel.call(this,a,e)).toJSON&&"function"==typeof a.toJSON&&(a=a.toJSON()),n.push(a)}return n},_childAdded:function(t){var e=h(t,this.idAttribute());!0===this._suppressEvent?(this._suppressEvent=!1,s.Collection.prototype.add.call(this,[e],{silent:!0})):s.Collection.prototype.add.call(this,[e]),this.get(e[this.idAttribute])._remoteAttributes=e},_childMoved:function(){},_childChanged:function(t){var e=this.idAttribute,s=Backbonefire._checkId(t,e),n=i.find(this.models,function(t){return t.id==s[e]});if(n){this._preventSync(n,!0),n._remoteAttributes=s;var r=i.difference(i.keys(n.attributes),i.keys(s));i.each(r,function(t){n.unset(t)}),n.set(s),this.trigger("sync",this),this._preventSync(n,!1)}else this._childAdded(t)},_childRemoved:function(t){var e=Backbonefire._checkId(t,this.idAttribute);!0===this._suppressEvent?(this._suppressEvent=!1,s.Collection.prototype.remove.call(this,[e],{silent:!0})):(this.trigger("sync",this),s.Collection.prototype.remove.call(this,[e]))},_updateModel:function(t){var e,s,n,r;t._remoteChanging||(e=t._remoteAttributes||{},s=t.toJSON(),n=this._compareAttributes(e,s),r=this.ref().child(t.id),i.has(n,".priority")?this._setWithPriority(r,s):this._updateToFirebase(r,s))},_compareAttributes:function(t,e){var s={},n=i.union(i.keys(t),i.keys(e));return i.each(n,function(n){i.has(e,n)?e[n]!=t[n]&&(s[n]=e[n]):s[n]=null}),s},_setWithPriority:function(t,e){var i=e[".priority"];return delete e[".priority"],t.setWithPriority(e,i),e},_updateToFirebase:function(t,e){t.update(e)},_removeModel:function(t,e,s){(s=s?i.clone(s):{}).success=i.isFunction(s.success)?s.success:function(){};var n=this.ref().child(t.id);_setWithCheck(n,null,i.bind(s.success,t))},_preventSync:function(t,e){t._remoteChanging=e}},t}();e.Collection=s.Collection.extend({model:l,initialize:function(t,e){var s=this.model;this._autoSync=o(s,e),this.database=c(this,e),this._autoSync?(i.extend(this,_.protoype),_.apply(this,arguments)):(i.extend(this,d.protoype),d.apply(this,arguments))},idAttribute:function(){return this.model.prototype.idAttribute||"id"},ref:function(t){return t=t||!1,(i.isUndefined(this._ref)||!0===t)&&this._setRef(),this._ref},_setRef:function(){var t=null;switch(typeof this.url){case"function":t=this.url();break;case"object":case"string":t=this.url;break;default:u("Invalid type passed to url property")}switch(typeof t){case"object":this._ref=this.url;break;case"string":this._ref=this._buildRef(t);break;default:u("Invalid type passed to url property")}this._configureRef()},_buildRef:function(t){var e=/https:\/\/.*\.firebaseio\.com/;return t.match(e)?this.database.refFromURL(t):this.database.ref(t)}});return e});